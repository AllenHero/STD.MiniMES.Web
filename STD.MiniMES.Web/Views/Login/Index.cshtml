<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>用户登录</title>
    <style>
        body, div, p, h1, h2, h3, h4, form, ul, li, dl, dt, dd, ol, img, a, span, em, i, strong, b, input, label {
            margin: 0;
            padding: 0;
        }

        img, a {
            display: block;
            padding: 0;
            margin: 0;
        }

        .leftlogin ul{
            display:none;
        }

        ul, li {
            list-style: none;
        }

        em, i {
            font-style: normal;
        }

        a {
            text-decoration: none;
            cursor: pointer; /*color: #3399cc;*/
        }

            a:hover {
                color: #3399ff;
            }

        body, html {
            font-size: 14px;
            color: #000;
            height: 100%;
            overflow: hidden;
            font-family: "微软雅黑";
        }

        .clearfix {
            clear: both;
            padding: 0;
            margin: 0;
        }

        * {
            box-sizing: border-box;
        }

        .login {
            width: 100%;
            overflow: hidden;
            margin: 0 auto;
        }

        .loginheader {
            width: 100%;
            height: 56px;
            float: left;
            background-color: #ffffff;
        }

            .loginheader .toplogo {
                padding-left: 10%;
                float: left;
            }

        .toplogo img {
            margin: 18px 15px 0px 0px;
        }

        .toplogo img, .toplogo p {
            float: left;
            line-height: 56px;
            color: #117db2;
            font-size: 23px;
            letter-spacing: 2px;
            font-weight: normal;
        }

        .logincontent {
            width: 100%;
            height: 540px;
            float: left;
            background: url(../../Content/images/login/dl-bg.png) no-repeat center;
            background-size: 100% 100%;
        }

        .logincenter .leftlogin, .logincenter .rightscan {
            float: left;
            width: 380px;
            height: 400px;
            margin-left: 6.5%;
        }

        .logincenter {
            width: 980px;
            overflow: hidden;
            margin: 0 auto;
            padding-top: 5%;
        }

        .leftlogin {
            background-color: #ffffff;
            padding-top: 20px;
            position: relative;
        }

            .leftlogin input {
                margin: 18px auto;
                display: block;
                width: 300px;
                height: 50px;
                padding: 5px;
            }

            .leftlogin h1, .rightscan h1 {
                text-align: center;
                line-height: 50px;
                font-size: 20px;
                color: #018cc0;
                font-weight: normal;
            }

            .leftlogin .warn,.leftlogin .warn0,.leftlogin .warn1 ,.leftlogin .warn2,.leftlogin .warn3{
                position: absolute;
                left: 40px;
                width: 300px;
                font-size: 12px;
                margin: 0 auto;
                text-align: center;
                color: #F30;
                line-height: 30px;
                height: auto;
            }

            .leftlogin .warn {
                top: 205px;
            }
            .leftlogin .warn0 {
                top: 320px;
            }
            .leftlogin .warn2 {
                top: 132px;
            }
            .leftlogin .warn3 {
                top: 360px;
            }
            .leftlogin .goback{
                position:absolute;
                width:385px;
                top:360px;
            }

        .checkbox1 {
            width: 300px;
            height: 40px;
            margin: 0 auto;
            line-height: 46px;
            color: #5a5a5a;
        }

            .checkbox1 input {
                width: 15px;
                height: 15px;
                float: left;
                margin-right: 10px;
            }

            .checkbox1 span {
                float: right;
                color: #fc923f;
            }

        .lgbutton input {
            background-color: #fc923f;
            font-family: "Microsoft YaHei UI";
            border: solid 1px #dbdbdb;
            border-radius: 4px;
            font-size: 20px;
            letter-spacing: 10px;
            color: #ffffff;
            cursor: pointer;
        }

        .co-account {
            text-align: center;
            color: #fc923f;
            font-size: 16px;
            padding-top: 0px;
        }

        .rightscan {
            background: url(../../Content/images/login/scale.png) no-repeat center;
            background-size: 94% 100%;
        }

            .rightscan img {
                margin: 0 auto;
                display: block;
            }

        .scanimg {
            margin-top: 20px;
        }

        .rightscan {
            padding-top: 30px;
        }

            .rightscan .scanfont {
                color: #fefefe;
                text-align: center;
                line-height: 50px;
            }

                .rightscan .scanfont span {
                    color: #fc923f;
                }

            .rightscan h1 {
                color: #ffffff;
                line-height: 50px;
                font-size: 20px;
                font-family: "Microsoft YaHei UI";
            }

        .loginfooter {
            text-align: center;
            font-size: 14px;
            color: #989898;
            line-height: 40px;
        }

        .alert {
            text-align: center;
            padding: 10px;
            font-size: 14px;
            border-radius: 0;
        }

        .alert-danger {
            color: #b94a48;
            background-color: #f2dede;
            border-color: #eed3d7;
        }

        .alert {
            margin-bottom: 20px;
            border: 1px solid transparent;
            border-top-color: transparent;
            border-right-color: transparent;
            border-bottom-color: transparent;
            border-left-color: transparent;
            border-radius: 4px;
        }
    </style>
    <link href="~/Content/js/jquery-easyui-1.3.2/themes/default/linkbutton.css" rel="stylesheet" />
    <script src="~/Content/js/jquery/jquery-1.8.3.min.js"></script>
    <script src="~/Content/js/core/json2.js"></script>
    <script src="~/Content/js/core/knockout-2.2.1.js"></script>
    <script src="~/Content/js/viewModel/login.js"></script>
    <script src="~/Content/ace/js/jquery.placeholder.js"></script>
    <script src="~/Scripts/jquery-qrcode.1.0/content/Scripts/qrcode.js"></script>
    <script src="~/Scripts/jquery-qrcode.1.0/content/Scripts/jquery.qrcode.js"></script>
    <script src="~/Content/js/core/common.js"></script>
    <script src="~/Content/js/core/hanzitopinyin.js"></script>
    <script src="~/Content/js/layer/layer.js"></script>

    @*<link href="~/Content/ace/css/ace.min.css" rel="stylesheet" />
        <link href="~/Content/ace/css/bootstrap.min.css" rel="stylesheet" />*@
</head>
<body>
    <div class="alert alert-danger hide" id="lowbrowser">
        您的浏览器版本过低，请使用IE9以及上版本或chrome、firefox浏览器访问！
        <br>
    </div>
    <div class="login">
        <div class="loginheader">
            <div class="toplogo"><img src="~/Content/images/login/Slogo.png"><p>智行管理系统</p></div>
        </div>
        <div class="logincontent">
            <div class="logincenter">
                <div class="leftlogin">
                    <ul class="step" id="userlogin">
                        <li><h1>智行管理系统账号登入</h1></li>
                        <li><input type="text" data-bind="value:form.usercode" placeholder="手机号" /></li>
                        <li><input type="password" autocomplete="off" data-bind="value:form.password" placeholder="密码"/></li>
                        <li class="warn"><div style="color:salmon;height:24px;text-align:center" data-bind="html:message"></div></li>
                        <li class="checkbox1"><input data-bind="checked:form.remember" type="checkbox" />记住我<span>@*忘记密码?*@</span></li>
                        <li class="lgbutton"><input id="login" type="button" data-bind="click:loginClick" value="登录"></li>
                        <li class="co-account" id="Enterprise"><a href="#" style="color:#fc923f">企业账号注册</a></li>
                    </ul>
                    <ul class="step" id="EnterpriseCheck">
                        <li><h1>企业账号注册</h1></li>
                        <li><input type="text" id="tenantnameid" onkeyup="value = value.replace(/\s+/g,'')" data-bind="    value: form.TenantName" placeholder="请输入企业法定名称" /></li>
                        <li><input type="tel" id="phonenumberid"  onkeyup="value=value.replace(/[^\d]/g,'') " maxlength="11" data-bind="value:form.PhoneNumber" placeholder="手机号"/></li>
                        <li class="lgbutton"><input id="nextstep" type="button" data-bind="click:EnterpriseCheckClick" value="下一步"/></li>
                        <li class="warn0"><div style="color:salmon;height:24px;text-align:center" data-bind="html:message"></div></li>
                        <li class="goback"><a href="#"><div class="pagelogin" style="float:right;color:#fc923f;font-size:14px;margin:10px;">返回登录</div></a></li>
                    </ul>
                    <ul class="step" id="EnterpriseRegister">
                        <li><h1>企业账号注册</h1></li>
                        <li><input type="text" id="tenantcodeid" onkeyup="value=value.replace(/[\W]/g,'') " maxlength="10" data-bind="value:form.TenantCode2" placeholder="企业账号"/></li>
                        <li class="warn2"><div style="color:grey;height:24px;text-align:center">只能是英文字母和数字</div></li>
                        <li><input type="text" id="usernameid"  onkeyup="value = value.replace(/[\d\s]/g, '')" data-bind="    value: form.UserName" placeholder="个人姓名"/></li>
                        <li><input type="password" id="passwordid"  autocomplete="off" data-bind="value:form.Password2" placeholder="登录密码" /></li>
                        <li class="lgbutton"><input type="button" data-bind="click:EnterpriseRegisterClick" value="保   存"/></li>
                        <li class="warn3"><div style="color:salmon;height:24px;text-align:center" data-bind="html:message"></div></li>
                        <li class="goback">
                            <a href="#"><div class="gobefore" style="float:left;color:#fc923f;font-size:14px;margin:10px;">上一步</div></a>
                            <a href="#"><div class="pagelogin" style="float:right;color:#fc923f;font-size:14px;margin:10px;">返回登录</div></a>
                        </li>
                    </ul>
                </div>
                <div class="rightscan">
                    <ul>
                        <li><h1>扫一扫登录</h1></li>
                        <li class="scanimg">
                            @*<img src="~/Content/images/login/scan.png">*@
                            <div id="divQRCode" class="codebox" style="background:none;margin-left:80px"></div>
                        </li>
                        <li class="scanfont">请使用<span>智行管理系统APP</span>扫描登录</li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="loginfooter" style="vertical-align:middle">Inc. All Rights Reserved（请使用IE9及以上版本或chrome、firefox浏览器访问）</div>
    </div>
</body>
</html>
<script>
    //alert(getCookie("asdf"));
    var tenant = '@STD.Framework.Utils.ZCookies.GetCookies("tenant")';
    
    function getbrowser() {
        if ($.browser.msie) {
            if ($.browser.version < 9) {
                $("#lowbrowser").removeClass("hide");
            }
            else {
                $("#lowbrowser").addClass("hide");
            }
        }
    }

    $(function () {
        $('.step').hide();
        $('#userlogin').show();
        //进入企业信息注册
        $('#Enterprise').click(function () {

            $('#tenantnameid').val("");
            $("#phonenumberid").val("");
            $('#tenantcodeid').val("");
            $('#usernameid').val("");
            $('#passwordid').val("");

            $('.step').hide();
            $('#EnterpriseCheck').show();
            $('div[data-bind="html:message"]').html("");
        });
        //返回登录页面
        $('.pagelogin').click(function () {
            $('.step').hide();
            $('#userlogin').show();
            $('div[data-bind="html:message"]').html("");
        });
        //返回企业名称输入
        $('.gobefore').click(function () {
            $('.step').hide();
            $('#EnterpriseCheck').show();
            $('div[data-bind="html:message"]').html("");
        });
        $('input[type="tel"]').focusout(function () {
            var sMobile = this.value
            if (!(/^1[3|4|5|8][0-9]\d{4,8}$/.test(sMobile)) || sMobile.length<11) {
                $(this).focus();
                $('.warn0').children("div").html("不是完整的11位手机号或者正确的手机号前七位");
            } else {
                var tenant = $('#tenantnameid').val();
                if($.trim(tenant)=='')
                {
                    $('#tenantnameid').focus();
                }
            }
        });
        getbrowser();

        $('input, textarea').placeholder();

        $(document).keypress(function (e) {
            // 回车键事件
            if (e.which == 13) {
                $("#login").click();
            }
        });

        //企业注册
        $('#Enterprise').click(function () {

        });

        var token = com.newGuid();

        createQRCode(token);

        function validateLogin() {
            //var data = new {
            //    token: token
            //}
            var data = "{'token':'" + token + "'}";
            $.ajax({
                type: "POST",
                url: "/login/Verify",
                data: data,
                dataType: "json",
                contentType: "application/json",
                success: function (result) {
                    if (result == "" || result == null) {
                        validateLogin();
                    } else {
                        $.ajax({
                            type: "POST",
                            url: "/login/ScanLogin",
                            data: data,
                            dataType: "json",
                            contentType: "application/json",
                            success: function (r) {
                                if (r != "" && r != null) {
                                    if (r.status == "success") {
                                        if (r.IsAdministrator == true) {
                                            window.location.href = '/Home/Index';
                                        }
                                        else {
                                            window.location.href = '/Home/Index';
                                            //window.location.href = '/EPS/Index';
                                        }
                                    }
                                    else {
                                        alert(r.message);
                                        token = com.newGuid();
                                        createQRCode(token);
                                        validateLogin();
                                    }
                                }
                            }
                        });
                    }
                }
            });
        }

        validateLogin();
    });

    function createQRCode(token) {
        $("#divQRCode").html("");
        $('#divQRCode').qrcode({ width: 218, height: 218, correctLevel: 0, text: token });
    }

    function getCookie(c_name) {
        if (document.cookie.length > 0) {
            c_start = document.cookie.indexOf(c_name + "=")
            if (c_start != -1) {
                c_start = c_start + c_name.length + 1
                c_end = document.cookie.indexOf(";", c_start)
                if (c_end == -1) c_end = document.cookie.length
                return unescape(document.cookie.substring(c_start, c_end))
            }
        }
        return ""
    }
</script>
